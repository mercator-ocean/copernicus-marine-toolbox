name: Push Docker Image on DockerHub

on:
    workflow_dispatch: {}

jobs:
    push-docker-image:
        runs-on: self-hosted
        timeout-minutes: 10

        steps:
            - name: Check out code
              uses: actions/checkout@v4

            - uses: mamba-org/setup-micromamba@v1
              with:
                  micromamba-version: '1.5.6-0'
                  micromamba-binary-path: ${{ runner.temp }}/bin/micromamba
                  environment-file: conda_environment.yaml
                  environment-name: copernicusmarine
                  condarc-file: .condarc
                  cache-environment: true
                  post-cleanup: 'all'

            - name: Build Docker image
              run: make build-docker-image
              shell: micromamba-shell {0}

            - name: Push Docker image
              env:
                  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
                  DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
              run: make push-docker-image
              shell: micromamba-shell {0}
